name: Build Stable OpenWrt for ZN-M2

on:
  push:
    branches: [ main ]
 # workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 180
    
    steps:
    - name: Checkout OpenWrt
      uses: actions/checkout@v4
      with:
        repository: openwrt/openwrt
        ref: v23.05.3
        path: openwrt

    # ================================
    # å¯é çš„è®¾å¤‡é…ç½®ä¿®æ”¹
    # ================================
    - name: Configure Device Settings
      run: |
        cd openwrt
        
        # ä½¿ç”¨å˜é‡ç®€åŒ–æ“ä½œ
        DEVICE_DIR="target/linux/ipq60xx/image"
        mkdir -p $DEVICE_DIR
        
        # åˆ›å»ºè®¾å¤‡é…ç½®æ–‡ä»¶
        cat > $DEVICE_DIR/generic.mk << 'END'
define Device/zn_m2
  $(call Device/FitImage)
  $(call Device/UbiFit)
  DEVICE_VENDOR := ZN
  DEVICE_MODEL := M2
  BLOCKSIZE := 128k
  PAGESIZE := 2048
  SOC := ipq6000
  DEVICE_DTS_CONFIG := config@cp03-c1
  
  DEFAULT_PACKAGES := \
    base-files busybox dropbear firewall fstools logd \
    mtd netifd opkg procd uci urandom-seed urng \
    kmod-ath10k-ct wpad-openssl \
    -ipq-wifi-zn_m2 \
    -kmod-nss-* -kmod-usb* -kmod-dwc3* -ppp* -qca-*
  
  DEVICE_PACKAGES := ipq-wifi-zn_m2
endef
TARGET_DEVICES += zn_m2
END
        
        # åˆ›å»ºæ ¸å¿ƒé…ç½®æ–‡ä»¶
        {
          echo "CONFIG_TARGET_ipq60xx=y"
          echo "CONFIG_TARGET_ipq60xx_generic=y"
          echo "CONFIG_TARGET_ipq60xx_generic_DEVICE_zn_m2=y"
          echo "CONFIG_PACKAGE_luci-app-openclash=y"
          echo "CONFIG_PACKAGE_wpad-openssl=y"
          echo "# ç¦ç”¨NSS/USB"
          echo "CONFIG_KERNEL_NSS_ENABLED=n"
          echo "CONFIG_PACKAGE_kmod-usb-core=n"
        } > .config
      
      # ================================
      # æ ‡å‡†åŒ–ç¼–è¯‘æµç¨‹
      # ================================
      - name: Prepare Environment
        run: |
          cd openwrt
          
          # æ›´æ–°å¹¶å®‰è£…ä¾èµ–
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          
          # åº”ç”¨åŸºæœ¬é…ç½®
          make defconfig
          
          # é¢„ä¸‹è½½æºç 
          make download -j$(nproc)
          
          # æœ€åæ£€æŸ¥é…ç½®
          if ! grep -q 'CONFIG_TARGET_DEVICE_zn_m2=y' .config; then
            echo "::error::è®¾å¤‡é…ç½®æœªåŠ è½½!"
            exit 1
          fi
    
      # ================================
      # æ™ºèƒ½ç¼–è¯‘æ­¥éª¤
      # ================================
      - name: Compile Firmware
        run: |
          cd openwrt
          
          # æ™ºèƒ½æ ¸å¿ƒåˆ†é…
          AVAILABLE_CORES=$(nproc)
          USABLE_CORES=$((AVAILABLE_CORES > 4 ? AVAILABLE_CORES - 2 : AVAILABLE_CORES))
          
          echo "ğŸ› ï¸ ä½¿ç”¨ $USABLE_CORES ä¸ªæ ¸å¿ƒè¿›è¡Œç¼–è¯‘..."
          make -j$USABLE_CORES V=s 2>&1 | tee build.log
          
          # ç¼–è¯‘åéªŒè¯
          if [ ! -d bin/targets/ipq60xx/generic ]; then
            echo "::error::ç¼–è¯‘ç›®å½•ç¼ºå¤±!"
            exit 1
          fi
          
          if ! ls bin/targets/ipq60xx/generic/*zn_m2*.bin 1>/dev/null 2>&1; then
            echo "::error::å›ºä»¶æ–‡ä»¶æœªç”Ÿæˆ!"
            exit 1
          fi
          
          # æ˜¾ç¤ºæˆåŠŸä¿¡æ¯
          firmware=$(ls bin/targets/ipq60xx/generic/*zn_m2*.bin)
          echo "âœ… å›ºä»¶ç”ŸæˆæˆåŠŸ: $(basename $firmware)"
          echo "ğŸ“ å¤§å°: $(du -h $firmware | cut -f1)"
    
      # ================================
      # ç»“æœå¤„ç†
      # ================================
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: zn_m2-firmware-${{ github.run_id }}
          path: |
            openwrt/bin/targets/ipq60xx/generic/*.bin
            openwrt/build.log
          retention-days: 7
