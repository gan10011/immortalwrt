name: Build Lean OpenWrt for ZN-M2

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 180
    
    steps:
    - name: Checkout OpenWrt
      uses: actions/checkout@v4
      with:
        repository: openwrt/openwrt
        ref: v23.05.3
        path: openwrt

    # æ ¸å¿ƒé…ç½®ä¿®æ”¹åŒº
    - name: Apply Device Specific Configuration
      run: |
        cd openwrt
        # [ä¿æŒåŸæœ‰è®¾å¤‡é…ç½®ä»£ç ]
        
    # ä¾èµ–å¤„ç†åŒº (æ·»åŠ çŠ¶æ€æ£€æŸ¥)
    - name: Setup Feeds
      run: |
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a luci-app-openclash
        
        # éªŒè¯é…ç½®æ˜¯å¦åŠ è½½
        if [ ! -f .config ]; then
          echo "::error::é…ç½®ç¼ºå¤±ï¼Œåˆ›å»ºä¸´æ—¶é…ç½®"
          cat > .config << 'EOF'
          CONFIG_TARGET_ipq60xx=y
          CONFIG_TARGET_ipq60xx_generic=y
          CONFIG_TARGET_ipq60xx_generic_DEVICE_zn_m2=y
          EOF
        fi
        make defconfig

    # ç¼–è¯‘å‡†å¤‡åŒº (æ·»åŠ å‰ç½®éªŒè¯)
    - name: Prepare Build
      run: |
        cd openwrt
        # å…³é”®ï¼šéªŒè¯ä¼˜åŒ–å‚æ•°
        if ! grep -q 'CONFIG_TARGET_OPTIMIZATION=".*fno-caller-saves.*"' .config; then
          echo "::warning::ä¼˜åŒ–å‚æ•°æœªç”Ÿæ•ˆï¼Œå¼ºåˆ¶é‡è®¾ï¼"
          sed -i '/CONFIG_TARGET_OPTIMIZATION/d' .config
          echo 'CONFIG_TARGET_OPTIMIZATION="-Os -pipe -fno-caller-saves -fno-plt"' >> .config
          make defconfig
        fi
        
        # ä¸‹è½½æºä»£ç 
        make download -j$(nproc)
        echo "âœ… æºç å‡†å¤‡å®Œæˆï¼Œå³å°†å¼€å§‹ç¼–è¯‘"

    # æ ¸å¿ƒç¼–è¯‘åŒº (æ·»åŠ æ—¥å¿—é‡å®šå‘)
    - name: Compile Firmware
      continue-on-error: false  # ç¡®ä¿å¤±è´¥æ—¶åœæ­¢
      timeout-minutes: 120
      run: |
        cd openwrt
        cores=$(nproc)
        echo "ğŸ› ï¸ ä½¿ç”¨ $cores ä¸ªæ ¸å¿ƒè¿›è¡Œç¼–è¯‘..."
        {
          # è®°å½•å®Œæ•´çš„ç¼–è¯‘æ—¥å¿—
          time make -j$cores V=s 2>&1
          echo $? > exitstatus
        } | tee build.log
        
        # æ£€æŸ¥ç¼–è¯‘çŠ¶æ€
        if [ $(cat exitstatus) -ne 0 ]; then
          echo "::error::ç¼–è¯‘å¤±è´¥ï¼é”™è¯¯ä»£ç : $(cat exitstatus)"
          exit 1
        fi

    # åå¤„ç†åŒº (æ·»åŠ ç¼–è¯‘æ—¶é—´æ˜¾ç¤º)
    - name: Verify Artifacts
      run: |
        cd openwrt/bin/targets/ipq60xx/generic/
        
        # è®°å½•ç¼–è¯‘è€—æ—¶
        duration=$((SECONDS))
        hours=$((duration/3600))
        minutes=$(( (duration%3600)/60 ))
        seconds=$((duration%60))
        echo "â±ï¸ ç¼–è¯‘ç”¨æ—¶: ${hours}h ${minutes}m ${seconds}s"
        
        # æ£€æŸ¥å›ºä»¶æ–‡ä»¶
        if ! ls *zn_m2*.bin 1>/dev/null 2>&1; then
          echo "::error::å›ºä»¶æœªç”Ÿæˆï¼å¯èƒ½åŸå› ï¼š"
          echo "1. è®¾å¤‡åç§°ä¸åŒ¹é…"
          echo "2. ç¼–è¯‘ä¸­é€”å¤±è´¥"
          echo "3. ç›®æ ‡è·¯å¾„é”™è¯¯"
          exit 1
        fi
        
        firmware=$(ls *zn_m2*.bin | head -1)
        echo "âœ… æˆåŠŸç”Ÿæˆå›ºä»¶: $firmware"
        echo "ğŸ“ æ–‡ä»¶å¤§å°: $(du -h $firmware | cut -f1)"

    # ç»“æœä¸Šä¼ åŒº
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: zn_m2-firmware-${{ github.run_number }}
        path: |
          openwrt/bin/targets/ipq60xx/generic/*.bin
          openwrt/build.log
        retention-days: 3
