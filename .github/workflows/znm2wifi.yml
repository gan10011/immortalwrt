name: Build OpenWrt for ZN-M2

on: [push]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout OpenWrt
      uses: actions/checkout@v4
      with:
        repository: openwrt/openwrt
        ref: v23.05.2
        path: openwrt

    - name: Apply device config
      run: |
        # 安全创建设备配置
        DEVICE_DIR="openwrt/target/linux/ipq60xx/image"
        mkdir -p $DEVICE_DIR
        
        cat << 'DEVICE_CFG' > $DEVICE_DIR/generic.mk
define Device/zn_m2
  \$(call Device/FitImage)
  \$(call Device/UbiFit)
  DEVICE_VENDOR := ZN
  DEVICE_MODEL := M2
  BLOCKSIZE := 128k
  PAGESIZE := 2048
  SOC := ipq6000
  DEVICE_DTS_CONFIG := config@cp03-c1
  
  DEFAULT_PACKAGES := \\
    base-files busybox dropbear firewall fstools logd \\
    mtd netifd opkg procd uci urandom-seed urng \\
    kmod-ath10k-ct wpad-openssl luci-app-openclash \\
    -ipq-wifi-zn_m2 \\
    -kmod-nss-* -kmod-usb* -kmod-dwc3* -ppp* -qca-*
  
  DEVICE_PACKAGES := ipq-wifi-zn_m2
endef
TARGET_DEVICES += zn_m2
DEVICE_CFG

    - name: Apply build config
      run: |
        cat << 'BUILD_CFG' > openwrt/.config
CONFIG_TARGET_ipq60xx=y
CONFIG_TARGET_ipq60xx_generic=y
CONFIG_TARGET_ipq60xx_generic_DEVICE_zn_m2=y
# 禁用NSS/USB
CONFIG_KERNEL_NSS_ENABLED=n
CONFIG_PACKAGE_kmod-usb-core=n
# 启用必要组件
CONFIG_PACKAGE_luci-app-openclash=y
CONFIG_PACKAGE_wpad-openssl=y
BUILD_CFG

    - name: Compile firmware
      run: |
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        make defconfig
        make download
        make -j$(nproc)
