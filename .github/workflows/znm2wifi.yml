name: znm2wifi

on:
  workflow_dispatch:
env:
  # 使用当前仓库作为源码源
  LOCAL_REPO: ${{ github.workspace }}
  CONFIG_FILE: configs/imjingjian-lite.config
  DIY_SCRIPT: ZN_M2-diy-script-lite.sh
  FIRMWARE_TAG: ZN_M2-WIFI-Lite
  TZ: Asia/Shanghai

jobs:
  Build:
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        # 启用子模块支持（如果使用）
        submodules: recursive
        # 获取完整历史记录（可选）
        fetch-depth: 0

    - name: Check Server Performance
      run: |
        echo "警告: 此编译针对低内存设备优化"
        echo "--------------------------内存信息--------------------------"
        free -h

    - name: Initialization Environment
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo apt-get update
        sudo apt-get -y install build-essential clang flex g++ gawk gcc-multilib \
          gettext git libncurses5-dev libssl-dev python3-distutils rsync unzip zlib1g-dev

    - name: Combine Disks
      uses: easimon/maximize-build-space@master
      with:
        swap-size-mb: 2048
        temp-reserve-mb: 512
        root-reserve-mb: 2048

    - name: Prepare Local Source
      run: |
        # 设置OpenWrt源代码路径
        echo "OPENWRT_PATH=$GITHUB_WORKSPACE" >> $GITHUB_ENV
        
        # 添加仓库信息到环境变量
        VERSION_INFO=$(git log -1 --date=short --format="作者: %an<br/>时间: %cd<br/>内容: %s<br/>hash: %H")
        echo "VERSION_INFO=$VERSION_INFO" >> $GITHUB_ENV
        
        # 获取分支信息
        REPO_BRANCH=$(git branch --show-current)
        echo "REPO_BRANCH=$REPO_BRANCH" >> $GITHUB_ENV
        echo "SOURCE_REPO=$(basename $GITHUB_REPOSITORY)" >> $GITHUB_ENV

    - name: Apply Lite Configuration
      run: |
        cd $OPENWRT_PATH
        cp $CONFIG_FILE .config
        cp $DIY_SCRIPT .
        chmod +x $DIY_SCRIPT
        ./$DIY_SCRIPT

    - name: Download DL Package
      run: |
        cd $OPENWRT_PATH
        make download -j4
        find dl -size -1024c -delete

    - name: Compile Lite Firmware
      id: compile
      run: |
        cd $OPENWRT_PATH
        echo "低内存优化编译 (使用-j2减少内存占用)"
        make -j2 || make -j1 V=s
        echo "status=success" >> $GITHUB_OUTPUT
        echo "FILE_DATE=$(date +"%Y.%m.%d")" >> $GITHUB_ENV

    - name: Organize Files
      if: steps.compile.outputs.status == 'success'
      run: |
        cd $OPENWRT_PATH/bin/targets/*/*
        # 仅保留必要文件
        rm -rf packages
        find . -type f $ -name "*.ipk" -o -name "*.manifest" $ -delete
        echo "FIRMWARE_PATH=$PWD" >> $GITHUB_ENV

    - name: Upload Firmware To Release
      if: steps.compile.outputs.status == 'success'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ env.FIRMWARE_TAG }}
        name: Lite Firmware for Low-Memory Devices (${{ env.FILE_DATE }})
        body: |
          ## 精简版固件 - 低内存优化
          - 移除了NSS和USB功能
          - 针对64-128MB内存设备优化
          - 默认地址: 192.168.1.1
          - 默认密码: password
          ### 源码信息
          - 仓库: ${{ github.repository }}
          - 分支: ${{ env.REPO_BRANCH }}
          - 版本信息: ${{ env.VERSION_INFO }}
        files: ${{ env.FIRMWARE_PATH }}/*.bin
