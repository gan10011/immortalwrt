name: Build Lean OpenWrt for ZN-M2

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 180
    
    steps:
    - name: Checkout OpenWrt
      uses: actions/checkout@v4
      with:
        repository: openwrt/openwrt
        ref: v23.05.3
        path: openwrt

    # ================================
    # ä¿®æ­£åçš„é…ç½®ä¿®æ”¹åŒº
    # ================================
    - name: Apply Device Specific Configuration
      run: |
        cd openwrt
        # ä¿®å¤ EOF æ–‡æ¡£æ ¼å¼é—®é¢˜
        cat << 'CONFIG' > target/linux/ipq60xx/image/generic.mk
define Device/zn_m2
  $(call Device/FitImage)
  $(call Device/UbiFit)
  DEVICE_VENDOR := ZN
  DEVICE_MODEL := M2
  BLOCKSIZE := 128k
  PAGESIZE := 2048
  SOC := ipq6000
  DEVICE_DTS_CONFIG := config@cp03-c1
  
  # å…³é”®ä¿®æ”¹ï¼šç²¾ç®€é»˜è®¤åŒ…
  DEFAULT_PACKAGES := \\
    base-files busybox dropbear firewall fstools logd \\
    mtd netifd opkg procd uci urandom-seed urng \\
    kmod-ath10k-ct wpad-openssl \\
    -ipq-wifi-zn_m2 \\
    -kmod-nss-* -kmod-usb* -kmod-dwc3* -ppp* -qca-*
  
  DEVICE_PACKAGES := ipq-wifi-zn_m2
endef
TARGET_DEVICES += zn_m2
CONFIG

        # åˆ›å»ºåŸºæœ¬é…ç½®æ–‡ä»¶ (é¿å…ä½¿ç”¨ EOF æ ‡ç­¾)
        echo "CONFIG_TARGET_ipq60xx=y" > .config
        echo "CONFIG_TARGET_ipq60xx_generic=y" >> .config
        echo "CONFIG_TARGET_ipq60xx_generic_DEVICE_zn_m2=y" >> .config
        echo "CONFIG_PACKAGE_luci-app-openclash=y" >> .config
        
        # å¼ºåˆ¶åº”ç”¨ä¼˜åŒ–å‚æ•°
        echo 'CONFIG_TARGET_OPTIMIZATION="-Os -pipe -fno-caller-saves -fno-plt"' >> .config

    # ================================
    # ä¾èµ–å¤„ç†åŒº - ä¿®å¤ heredoc é—®é¢˜
    # ================================
    - name: Setup Feeds
      run: |
        cd openwrt
        
        # ä½¿ç”¨æ›´å®‰å…¨çš„æ–¹å¼æ¸…é™¤ NSS ä¾èµ–
        find . -name "*nss*" -type f -delete 2>/dev/null || true
        sed -i '/nss/d' feeds/luci/applications/luci-app-*/Makefile 2>/dev/null || true
        
        # æ›´æ–°å’Œå®‰è£…æº
        ./scripts/feeds update -a
        ./scripts/feeds install -a luci-app-openclash

    # ================================
    # ç¼–è¯‘å‡†å¤‡åŒº
    # ================================
    - name: Prepare Build
      run: |
        cd openwrt
        # ç¡®ä¿é…ç½®æ–‡ä»¶å­˜åœ¨
        if [ ! -f .config ]; then
          echo "::error::é…ç½®æ–‡ä»¶ç¼ºå¤±!"
          exit 1
        fi
        
        # åº”ç”¨é…ç½®
        make defconfig
        make download -j$(nproc)

    # ================================
    # ä¿®å¤çš„ç¼–è¯‘æ­¥éª¤
    # ================================
    - name: Compile Firmware
      timeout-minutes: 120
      run: |
        cd openwrt
        
        # è·å–æ ¸å¿ƒæ•°ä½†é™åˆ¶æœ€å¤§æ•°é‡
        cores=$(($(nproc) > 8 ? 8 : $(nproc)))
        
        echo "ğŸ› ï¸ ä½¿ç”¨ $cores ä¸ªæ ¸å¿ƒè¿›è¡Œç¼–è¯‘..."
        make -j$cores V=s 2>&1 | tee build.log
        
        # æ£€æŸ¥æ˜¯å¦æˆåŠŸç¼–è¯‘
        if ! ls bin/targets/*/*/*.bin 2>/dev/null | grep -q .; then
          echo "::error::ç¼–è¯‘å¤±è´¥ï¼Œæœªç”Ÿæˆå›ºä»¶æ–‡ä»¶"
          exit 1
        fi

    # ================================
    # ç»“æœä¸Šä¼ åŒº
    # ================================
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: zn_m2-firmware-${{ github.run_id }}
        path: |
          openwrt/bin/targets/ipq60xx/generic/*.bin
          openwrt/build.log
        retention-days: 3
